<p align="center">
  <p align="center">
    <a href="https://app.val.build">
<svg width="100" height="100" viewBox="0 0 944 944" fill="none" xmlns="http://www.w3.org/2000/svg">
<circle cx="472" cy="472" r="472" fill="#1D1C28"/>
<g filter="url(#filter0_d_14_601)">
<path d="M181 348C181 345.791 182.791 344 185 344H320C322.209 344 324 345.791 324 348V602C324 604.209 322.209 606 320 606H185C182.791 606 181 604.209 181 602V348Z" fill="#38CD80"/>
</g>
<g filter="url(#filter1_i_14_601)">
<circle cx="252" cy="550" r="24" fill="#1E1F2A"/>
</g>
<path d="M659.085 550.374H658.585H654.427C652.095 550.374 650.434 549.729 649.347 548.522C648.25 547.306 647.658 545.431 647.658 542.807V439.857C647.658 437.924 646.091 436.357 644.158 436.357H629.16C627.227 436.357 625.66 437.924 625.66 439.857V455.828C625.66 456.658 624.986 457.332 624.155 457.332C623.593 457.332 623.072 457.015 622.798 456.508C618.502 448.559 612.704 442.661 605.399 438.838C597.962 434.671 589.622 432.592 580.394 432.592C571.897 432.592 563.846 434.128 556.247 437.2C548.643 440.274 541.944 444.796 536.154 450.761L536.153 450.761C530.537 456.552 526.106 463.693 522.854 472.174C519.598 480.668 517.975 490.411 517.975 501.395V505.697C517.975 516.86 519.597 526.693 522.854 535.187C526.105 543.667 530.535 550.895 536.148 556.864L536.153 556.869L536.159 556.875C541.95 562.659 548.647 567.088 556.246 570.161L556.256 570.165C563.856 573.057 572.083 574.5 580.932 574.5C589.456 574.5 597.527 572.325 605.137 567.982C612.625 563.807 618.519 557.469 622.822 548.992C623.085 548.475 623.609 548.147 624.176 548.147H624.546C625.161 548.147 625.66 548.646 625.66 549.261C625.66 555.468 627.583 560.617 631.452 564.665L631.451 564.665L631.46 564.673C635.511 568.72 640.668 570.735 646.889 570.735H658.585H659.085H661.157H661.657H760C761.933 570.735 763.5 569.168 763.5 567.235V553.874C763.5 551.941 761.933 550.374 760 550.374H733.542C732.161 550.374 731.042 549.255 731.042 547.874V385C731.042 383.067 729.475 381.5 727.542 381.5H680.701C678.768 381.5 677.201 383.067 677.201 385V398.361C677.201 400.294 678.768 401.861 680.701 401.861H706.543C707.924 401.861 709.043 402.981 709.043 404.361V547.874C709.043 549.255 707.924 550.374 706.543 550.374H661.657H661.157H659.085ZM600.117 550.146L600.111 550.149C594.977 552.448 589.304 553.601 583.086 553.601C570.468 553.601 560.194 549.435 552.222 541.12C544.436 532.633 540.512 520.847 540.512 505.697V501.395C540.512 494.274 541.581 487.79 543.712 481.936L543.714 481.931C545.849 475.89 548.778 470.842 552.495 466.775C556.398 462.521 560.92 459.246 566.061 456.944C571.195 454.645 576.867 453.492 583.086 453.492C589.117 453.492 594.696 454.731 599.829 457.207L599.838 457.211L599.848 457.215C605.166 459.517 609.681 462.79 613.4 467.035L613.4 467.035L613.408 467.044C617.306 471.292 620.324 476.431 622.458 482.469L622.459 482.474C624.59 488.328 625.66 494.812 625.66 501.933V505.16C625.66 512.46 624.59 519.125 622.458 525.159C620.324 531.022 617.393 536.075 613.669 540.326C609.95 544.571 605.435 547.844 600.117 550.146ZM464.902 570.735C466.39 570.735 467.716 569.794 468.206 568.389L512.685 441.011C513.479 438.736 511.79 436.357 509.38 436.357H491.006C489.496 436.357 488.157 437.325 487.683 438.758L447.951 558.864C447.716 559.575 447.051 560.055 446.303 560.055C445.554 560.055 444.89 559.575 444.655 558.864L404.923 438.758C404.449 437.325 403.109 436.357 401.6 436.357H383.225C380.815 436.357 379.126 438.736 379.921 441.011L424.399 568.389C424.89 569.794 426.215 570.735 427.704 570.735H464.902Z" fill="white" stroke="white"/>
<defs>
<filter id="filter0_d_14_601" x="127.464" y="290.464" width="250.072" height="369.072" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset/>
<feGaussianBlur stdDeviation="26.768"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0.219608 0 0 0 0 0.803922 0 0 0 0 0.501961 0 0 0 0.3 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_14_601"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_14_601" result="shape"/>
</filter>
<filter id="filter1_i_14_601" x="228" y="526" width="48" height="48" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset/>
<feGaussianBlur stdDeviation="6"/>
<feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1"/>
<feColorMatrix type="matrix" values="0 0 0 0 0.219608 0 0 0 0 0.803922 0 0 0 0 0.501961 0 0 0 0.3 0"/>
<feBlend mode="normal" in2="shape" result="effect1_innerShadow_14_601"/>
</filter>
</defs>
</svg>
    </a>
    <br/>
  </p>
</p>

# üêâ HERE BE DRAGONS üêâ

Val is PRE-ALPHA - MOST features are broken and in state of flux.

This is release is only for **INTERNAL** **TESTING** PURPOSES.

## Table of contents

- [Table of contents](#table-of-contents)
- [Introduction](#introduction)
- [Installation](#installation)
- [Getting started](#getting-started)
- [Concepts](#concepts)
- [String](#string)
- [Number](#number)
- [Boolean](#boolean)
- [Optional](#optional)
- [Array](#array)
- [Object](#object)
- [Rich text](#richtext)
- [Image](#image)
- [Internalization](#internalization)
- [Union](#union)
- [One-of references](#one-of-references)
- [Remote](#remote)
- [Selector](#selector)

## Introduction

Val is a CMS where **content** is **code** in your git repo.

That means you get a CMS as normal where editors can:

- change content without developer interactions
- change images
- work with i18n

But, with all the benefits of having content hard-coded:

- works as normal with your favorite IDE without any plugins: search for content, references to usages, ...
- content is type-checked so you see when something is wrong immediately
- content can be refactored (change names, etc) just as if it was hard-coded (because it sort of is)
- work locally or in branches just as if you didn't use a CMS
- no need for code-gen and extra build steps

## Installation

- Make sure you have TypeScript 5+, Next 13.4+ (other meta frameworks will come), React 18.20.+ (other frontend frameworks will come)
- Install the packages:

```sh
npm install @valbuild/next@latest
```

- Create your val.config.ts file. NOTE: this file should be in the same directory as `tsconfig.json`:

```ts
// ./val.config.ts

import { initVal } from "@valbuild/next";

const { s, val } = initVal();

export { s, val };
```

- Create the endpoints file:

```ts
// ./src/pages/api/val/[...val].ts

import { createRequestListener } from "@valbuild/server";
import { NextApiHandler } from "next";

const handler: NextApiHandler = createRequestListener("/api/val", {
  valConfigPath: "./val.config",
});

export default handler;

export const config = {
  api: {
    responseLimit: false,
    bodyParser: false,
    externalResolver: true,
  },
};
```

- Use the Val provider in the root layout file:

```tsx
// ./app/layout.tsx

import { ValProvider } from "@valbuild/next";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <ValProvider> {children}</ValProvider>
      </body>
    </html>
  );
}
```

### [OPTIONAL]: Setup eslint

Install the eslint package:

```bash
npm install @valbuild/eslint-plugin@latest
```

Add the following to your `.eslintrc.json`:

```json
  "plugins": ["@valbuild"],
  "rules": {
    "@valbuild/no-illegal-module-ids": "error"
  }
```

## Getting started

### Create your first Val content file

Content defined in Val is always defined `.val.{ts|js}` files.

They must export a default `val.content` where the first argument equals the path of the file relative to the `val.config.{js|ts}` file.

```ts
// ./src/content/example/blogs.val.ts

import { s, val } from "../../../val.config";

export default val.content(
  "/src/content/example/blogs", // <- NOTE: this must be the same path as the file
  s.array(s.object({ title: s.string(), text: s.string() })),
  [
    {
      title: "Title 1",
      text: "Text 1",
    },
    {
      title: "Title 2",
      text: "Text 2",
    },
  ]
);
```

### Use your content

```tsx
// ./src/pages/example/index.tsx

import { NextPage } from "next";
import { useVal } from "@valbuild/next/client";
import blogsVal from "@/content/example/blogs.val";

const Blog: NextPage = () => {
  const blog = useVal(blogsVal[0]);
  return (
    <main>
      <article>
        <section>
          <h1>{blog.title}</h1>
          <p>{blog.text}</p>
        </section>
      </article>
    </main>
  );
};

export default Blog;
```

## Concepts

`.val.{ts|js}` files **MUST** have a default export which is a ValModule. A ValModule is a special type of [Selector](#selectors). Selectors makes it possible to select a subset of content from a ValModule or a another Selector.

Selectors can be turned to Val types using `useVal` or `fetchVal`.

### .val files

`.val.{ts|js}` files are the files in which you store your content.

They are evaluated when the content is run, therefore they have a specific set of requirements. They must have a default export that is `val.content`, they must have a `export const schema` with the Schema and they CANNOT import anything other than `val.config` and `@valbuild/core`.

Example:

```ts
import { s, val } from "../val.config";

export const schema = t.string();

export default val.content(
  "/file/path/relative/to/val/config",
  schema,
  "My string content"
);
```

NOTE: IN THE FUTURE, they will be validated by the eslint-plugin.

## String

```ts
import { s } from "./val.config";

s.string(); // <- Schema<string>
```

### String selectors

See [Selectors](#selector) for more info.

### String `.eq`

```ts
useVal(stringVal.eq("")); // <- Val<boolean>
```

## Number

```ts
import { s } from "./val.config";

s.number(); // <- Schema<number>
```

### Number selectors

See [Selectors](#selector) for more info.

### Number `.eq`

```ts
useVal(numberVal.eq(2)); // <- Val<boolean>
```

## Boolean

```ts
import { s } from "./val.config";

s.boolean(); // <- Schema<boolean>
```

### Boolean selectors

See [Selectors](#selector) for more info.

### Boolean `.eq`

```ts
useVal(booleanVal.eq(true)); // <- Val<boolean>
```

## Optional

All schema types can be optional. An optional schema creates a union of the type and `null`.

```ts
import { s } from "./val.config";

s.string().optional(); // <- Schema<string | null>
```

### Selectors

### Accessing the underlying type: `.andThen`

To use and optional val, you can use the [.andThen](#andthen) selector.

## Array

```ts
s.array(t.string());
```

### Selecting arrays

### `.filter`

TODO: text

```ts
useVal(myArray.filter((item) => item.title.eq("Title 1")));
```

### `.map`

TODO:

```ts
useVal(myArray.map((item) => ({ test: item.title })));
```

## Object

```ts
s.object({
  myProperty: s.string(),
});
```

### Selecting objects

You can select Selector objects almost as if they were normal objects. The exception is that you cannot use the spread (`...`) operator.

Example:

```ts
useVal({ foo: myObjectVal.hello });
```

## RichText

### RichText Schema

```ts
import { s } from "./val.config";

s.richtext();
```

### Initializing RichText content

To initialize some text content using a RichText schema, you can use follow the example below:

```ts
import { s, val } from "./val.config";

// TODO: need some other way of doing this:
export default val.content("/example/richtext.ts", s.richtext(), {
  children: [
    {
      type: "paragraph",
      version: 1,
      indent: 0,
      direction: "ltr",
      format: "",
      children: [
        {
          type: "text",
          version: 1,
          mode: "normal",
          format: 0,
          detail: 0,
          style: "",
          text: "TODO: update me",
        },
      ],
    },
  ],
  direction: "ltr",
  format: "",
  indent: 0,
  type: "root",
  version: 1,
});
```

### Render RichText

You can use the `ValRichText` component to render content.

```tsx
"use client";
import { useVal, ValRichText } from "@valbuild/react";
import richtextVal from "./richtext";

export default function Page() {
  const richtext = useVal(richtextVal);
  return <ValRichText>{richtext}</ValRichText>;
}
```

## Image

### Schema

```ts
s.image();
```

### Initializing image content

Local images must be stored under the `.public` folder.

```ts
import { s, val } from "../val.config";

export const schema = s.image();

export default val.content("/image", schema, val.file("/public/myfile.jpg"));
```

NOTE: This will not validate, since images requires `width`, `height` and a `sha256` checksum. You can fix this validation in the UI by opening the image and clicking the Fix button.

### Using images in components

Images are transformed to object that have a `url` property which can be used to render them.

Example:

```tsx
// in a Functional Component
const image = useVal(imageVal);

return <img src={image.url} />;
```

## Internalization

**NOTE**: WORKS ONLY ON THE TYPE LEVEL

To enable i18n, you must update your Val with the locales you want to enforce.

Example:

```ts
// ./val.config.ts

import { initVal } from "@valbuild/core";

const { s, val } = initVal({
  locales: {
    required: ["en_US", "fr_FR"],
    fallback: "en_US",
  },
});

export { s, val };
```

## Union

**NOTE**: WORKS ONLY ON THE TYPE LEVEL

TODO: fill in.

```ts
s.union(
  "type",
  s.object({ type: s.literal("type1"), bar: s.string() }),
  s.object({ type: s.literal("type2"), foo: s.number() })
);
```

### Selecting unions

### `.fold`

TODO: description

```ts
useVal(myUnionVal.fold("type")({

})
```

## One of references

**NOTE**: Currently not possible to change from UI

```ts

```

# Remote

**NOTE**: WORKS ONLY ON THE TYPE LEVEL

All schemas can be converted into `.remote`.

TODO: add description.

Example:

```ts
export const schema = s.object({ stuff: s.string() });

export default val.content("/remote/example", schema, val.remote("REFERENCE"));
```

## Selector

To select parts of a your content you should use Selectors.
If you make the content `.remote`

### `.andThen`

All selectors can use `andThen` method which is similar to the `&&` operator. You can use this to only do operations on optionals that are defined. NOTE: only TRUTHY arguments are passed in to `andThen` (i.e. the empty string, `''` is NOT truthy).

Given the example schema:

```ts
// ./maybeArray.val.ts
//...

export const schema = t.array(t.string()).optional();

//...
```

```ts
import maybeArrayVal from "./maybeArray.val";
useVal(maybeArrayVal.andThen((array) => array.filter((v) => v.eq("foo"))));
```
